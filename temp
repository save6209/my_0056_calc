<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡å¤šæª”ç›£æ§èˆ‡è¤‡åˆ©ç³»çµ± V15</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { @apply bg-white rounded-3xl p-5 shadow-sm border border-slate-200 transition-all; }
        .label-txt { @apply text-[10px] font-extrabold text-slate-400 uppercase tracking-widest mb-1 block; }
        .input-box { @apply w-full text-lg font-bold text-slate-800 outline-none border-b-2 border-slate-100 focus:border-blue-600 bg-transparent py-1; }
        .tab-btn { @apply flex-1 py-3 text-xs md:text-sm font-bold text-slate-500 transition-all rounded-xl; }
        .tab-btn.active { @apply bg-white text-blue-600 shadow-md; }
        .btn-action { @apply p-2 rounded-lg bg-slate-100 hover:bg-blue-600 hover:text-white transition-all font-bold; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
        .active-dot { animation: pulse-green 2s infinite; @apply bg-green-500 w-2 h-2 rounded-full; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-2xl md:text-4xl font-black text-slate-900 tracking-tighter">å°è‚¡å¤šæª”ç›£æ§ç³»çµ± <span class="text-blue-600">V15</span></h1>
            <div class="flex items-center justify-center mt-2 space-x-2">
                <div class="active-dot"></div>
                <p id="global-timer" class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">ç³»çµ±é€£ç·šä¸­...</p>
            </div>
        </header>

        <div class="flex bg-slate-200/50 p-1 rounded-[22px] mb-8 max-w-2xl mx-auto">
            <button onclick="showTab('watch')" class="tab-btn active" id="btn-watch">ğŸ“¡ å³æ™‚è‡ªè¨‚ç›£æ§</button>
            <button onclick="showTab('calc')" class="tab-btn" id="btn-calc">ğŸ’° è¤‡åˆ©æ¨¡æ“¬å™¨</button>
            <button onclick="showTab('info')" class="tab-btn" id="btn-info">ğŸ“˜ ç³»çµ±èªªæ˜</button>
        </div>

        <div id="watch-tab" class="tab-content active space-y-6">
            <div class="card bg-slate-900 p-6 flex flex-col md:flex-row items-center gap-4">
                <div class="flex-1 w-full">
                    <label class="label-txt text-slate-500">æ–°å¢è‚¡ç¥¨ä»£è™Ÿ (ä¾‹å¦‚: 0056, 2330)</label>
                    <input type="text" id="new-stock-id" placeholder="è¼¸å…¥ä»£è™Ÿ..." class="bg-transparent text-white text-2xl font-black outline-none border-b-2 border-slate-700 focus:border-blue-500 w-full">
                </div>
                <button onclick="addStockCard()" class="w-full md:w-auto bg-blue-600 text-white px-8 py-4 rounded-2xl font-black hover:bg-blue-500 transition-all shadow-lg shadow-blue-900/20">
                    + æ–°å¢ç›£æ§
                </button>
            </div>

            <div id="stock-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </div>
        </div>

        <div id="calc-tab" class="tab-content space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                <div class="card"><label class="label-txt">ç›®å‰é¸å®šè‚¡åƒ¹</label><input type="number" id="principal-price" value="0" class="input-box text-blue-600" readonly></div>
                <div class="card"><label class="label-txt">åˆå§‹æŠ•å…¥ (è¬)</label><input type="number" id="principal" value="100" class="input-box"></div>
                <div class="card bg-blue-50/50"><label class="label-txt text-blue-600">å¹´åŒ–æ®–åˆ©ç‡ %</label><input type="number" id="yieldRate" value="7.0" step="0.1" class="input-box text-blue-800"></div>
                <div class="card"><label class="label-txt">å¹´åŒ–å¢å€¼ %</label><input type="number" id="priceGrowth" value="3.5" step="0.1" class="input-box"></div>
                <div class="card"><label class="label-txt">æ‰€å¾—ç¨…ç‡</label><select id="taxRate" class="input-box"><option value="0.05">5%</option><option value="0.20">20%</option></select></div>
            </div>

            <div class="card p-8 border-l-8 border-slate-900">
                <h3 class="font-black text-sm mb-6 uppercase tracking-widest text-slate-400">æ¨¡æ“¬è¨­å®šèˆ‡åŸ·è¡Œ</h3>
                <button onclick="calculate()" class="w-full bg-slate-900 text-white font-black py-5 rounded-3xl shadow-xl hover:scale-[1.01] active:scale-95 transition-all">é–‹å§‹è¨ˆç®—è¤‡åˆ©æˆé•·</button>
            </div>

            <div id="resultArea" class="hidden space-y-4">
                <div id="sumArea" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
                <div class="card p-0 overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-xs text-left"><thead class="bg-slate-800 text-slate-300"><tr id="tableHead"></tr></thead><tbody id="detailBody" class="divide-y divide-slate-100"></tbody></table></div></div>
            </div>
        </div>

        <div id="info-tab" class="tab-content space-y-6">
            <div class="card">
                <h2 class="font-black text-xl mb-4">V15 ç‰ˆæœ¬æŒ‡å—</h2>
                <ul class="list-disc ml-5 space-y-2 text-slate-600 text-sm">
                    <li><b>å¤šæª”ç›£æ§ï¼š</b>æ‚¨å¯ä»¥åœ¨ç¬¬ä¸€å€‹åˆ†é è¼¸å…¥å¤šå€‹ä»£è™Ÿï¼Œç³»çµ±æœƒåŒæ™‚è¿½è¹¤ã€‚</li>
                    <li><b>å³æ™‚èª¿æ•´ï¼š</b>ä½¿ç”¨å¡ç‰‡ä¸Šçš„ <span class="font-bold text-blue-600">+/-</span> æŒ‰éˆ•ï¼Œå¯ä»¥è‡ªå®šç¾©ã€Œåƒ¹å·®ã€ã€‚ä¾‹å¦‚ç¾åƒ¹ 38 å…ƒï¼Œä½ èª¿æ•´ -1 å…ƒï¼Œæ¨¡æ“¬å™¨å°‡ä»¥ 37 å…ƒä½œç‚ºåŸºæº–ã€‚</li>
                    <li><b>è‡ªå‹•å¸¶å…¥ï¼š</b>é»æ“Šå¡ç‰‡ä¸Šçš„ã€Œå¸¶å…¥æ¨¡æ“¬ã€ï¼Œæ•¸æ“šæœƒè‡ªå‹•å¡«å…¥ç¬¬äºŒåˆ†é ã€‚</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let watchlist = ["0056", "0050", "2330"]; // é è¨­åˆ—è¡¨
        let stockDataMap = {}; // å­˜æ”¾å„ä»£è™Ÿçš„å³æ™‚æ•¸æ“šèˆ‡ Offset

        // 1. åˆ†é æ§åˆ¶
        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');
            document.getElementById('btn-' + tab).classList.add('active');
        }

        // 2. æ–°å¢è‚¡ç¥¨å¡ç‰‡
        async function addStockCard() {
            const idInput = document.getElementById('new-stock-id');
            const id = idInput.value.trim();
            if (id && !watchlist.includes(id)) {
                watchlist.push(id);
                idInput.value = "";
                await refreshAllPrices();
            }
        }

        function removeStock(id) {
            watchlist = watchlist.filter(item => item !== id);
            renderCards();
        }

        // 3. èª¿æ•´åƒ¹å·® (Offset)
        function adjustOffset(id, amount) {
            if (!stockDataMap[id]) return;
            stockDataMap[id].offset += amount;
            renderCards();
        }

        // 4. æŠ“å– API ä¸¦æ¸²æŸ“å¡ç‰‡
        async function refreshAllPrices() {
            document.getElementById('global-timer').innerText = "æ›´æ–°ä¸­...";
            for (let id of watchlist) {
                try {
                    const res = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${id}&start_date=${new Date(Date.now()-86400000*5).toISOString().split('T')[0]}`);
                    const result = await res.json();
                    if (result.data && result.data.length > 0) {
                        const last = result.data[result.data.length - 1];
                        if (!stockDataMap[id]) stockDataMap[id] = { offset: 0 };
                        stockDataMap[id].price = last.close;
                        stockDataMap[id].change = (((last.close - last.open)/last.open)*100).toFixed(2);
                    }
                } catch (e) { console.error(id + " æŠ“å–å¤±æ•—"); }
            }
            renderCards();
            document.getElementById('global-timer').innerText = "æœ€å¾Œæ›´æ–°: " + new Date().toLocaleTimeString();
        }

        function renderCards() {
            const container = document.getElementById('stock-container');
            container.innerHTML = "";
            watchlist.forEach(id => {
                const data = stockDataMap[id] || { price: 0, change: 0, offset: 0 };
                const adjustedPrice = (data.price + data.offset).toFixed(2);
                const colorClass = data.change >= 0 ? 'text-rose-500' : 'text-green-500';

                container.innerHTML += `
                    <div class="card border-2 border-transparent hover:border-blue-500">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <span class="font-black text-2xl text-slate-800">${id}</span>
                                <span class="block text-[10px] font-bold text-slate-400">å¸‚å ´ç¾åƒ¹: $${data.price || '---'}</span>
                            </div>
                            <button onclick="removeStock('${id}')" class="text-slate-300 hover:text-rose-500">âœ•</button>
                        </div>
                        <div class="bg-slate-50 rounded-2xl p-4 mb-4">
                            <label class="label-txt text-center">èª¿æ•´å¾Œé ç®—åƒ¹</label>
                            <div class="flex items-center justify-between">
                                <button onclick="adjustOffset('${id}', -0.5)" class="btn-action">-0.5</button>
                                <span class="text-3xl font-black text-blue-600">$${adjustedPrice}</span>
                                <button onclick="adjustOffset('${id}', 0.5)" class="btn-action">+0.5</button>
                            </div>
                            <div class="text-center text-[10px] font-bold text-slate-400 mt-2">åƒ¹å·®åç§»: ${data.offset.toFixed(1)}</div>
                        </div>
                        <button onclick="applyToCalc('${id}', ${adjustedPrice})" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold text-sm hover:bg-blue-600 transition-all">
                            å¸¶å…¥æ¨¡æ“¬å™¨
                        </button>
                    </div>
                `;
            });
        }

        // 5. å°‡é¸å®šè‚¡ç¥¨å¸¶å…¥æ¨¡æ“¬åˆ†é 
        function applyToCalc(id, price) {
            document.getElementById('principal-price').value = price;
            // å‡è¨­ä¸€å€‹é‚è¼¯ï¼šè‹¥ç‚º 0056 å‰‡é è¨­æ®–åˆ©ç‡ 7%ï¼Œå…¶é¤˜ 5% (å¯è‡ªè¨‚)
            document.getElementById('yieldRate').value = id.startsWith('00') ? 7.0 : 5.0;
            showTab('calc');
            alert(`å·²é¸å®š ${id}ï¼Œèª¿æ•´åƒ¹ $${price}ã€‚è«‹è‡³æ¨¡æ“¬å™¨è¨­å®šæœ¬é‡‘ã€‚`);
        }

        // 6. è¤‡åˆ©è¨ˆç®—é‚è¼¯ (ç¹¼æ‰¿ V12-14)
        function calculate() {
            const price = parseFloat(document.getElementById('principal-price').value) || 1;
            const principalWan = parseFloat(document.getElementById('principal').value) || 0;
            const yr = parseFloat(document.getElementById('yieldRate').value) / 100;
            const pg = parseFloat(document.getElementById('priceGrowth').value) / 100;
            
            let currentMV = principalWan;
            let html = "";
            for (let i = 1; i <= 10; i++) {
                let div = currentMV * yr;
                currentMV = currentMV * (1 + pg) + div;
                html += `<tr><td class="p-4 font-bold text-slate-400">${i}Y</td><td class="p-4 font-black text-slate-800">${currentMV.toFixed(0)}è¬</td><td class="p-4 text-emerald-600 font-bold">+${div.toFixed(1)}è¬</td></tr>`;
            }
            document.getElementById('detailBody').innerHTML = html;
            document.getElementById('tableHead').innerHTML = `<th class="p-4">å¹´ä»½</th><th class="p-4">é ä¼°å¸‚å€¼</th><th class="p-4">ç•¶å¹´é…æ¯</th>`;
            document.getElementById('resultArea').classList.remove('hidden');
        }

        // åˆå§‹åŒ–
        refreshAllPrices();
        setInterval(refreshAllPrices, 60000);
    </script>
</body>
</html>
