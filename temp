<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡å¤§æ•¸æ“šè¤‡åˆ©ç³»çµ± V16</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { @apply bg-white rounded-3xl p-5 shadow-sm border border-slate-200; }
        .label-txt { @apply text-[10px] font-extrabold text-slate-400 uppercase tracking-widest mb-1 block; }
        .input-box { @apply w-full text-lg font-bold text-slate-800 outline-none border-b-2 border-slate-100 focus:border-blue-600 bg-transparent py-1; }
        .tab-btn { @apply flex-1 py-3 text-xs md:text-sm font-bold text-slate-500 transition-all rounded-xl; }
        .tab-btn.active { @apply bg-white text-blue-600 shadow-md; }
        .btn-action { @apply p-2 rounded-lg bg-slate-100 hover:bg-blue-600 hover:text-white transition-all font-bold; }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-black text-slate-900 tracking-tighter">å°è‚¡å¤§æ•¸æ“šè¤‡åˆ©ç³»çµ± <span class="text-blue-600">V16</span></h1>
            <p class="text-[10px] text-slate-400 font-bold uppercase mt-2">Historical Backtest & Real-time Monitor</p>
        </header>

        <div class="flex bg-slate-200/50 p-1 rounded-[22px] mb-8 max-w-2xl mx-auto">
            <button onclick="showTab('watch')" class="tab-btn active" id="btn-watch">ğŸ“¡ ç›£æ§èˆ‡å›æ¸¬</button>
            <button onclick="showTab('calc')" class="tab-btn" id="btn-calc">ğŸ’° è¤‡åˆ©æ¨¡æ“¬å™¨</button>
        </div>

        <div id="watch-tab" class="tab-content active space-y-6">
            <div class="card bg-slate-900 p-6 flex flex-col md:flex-row items-center gap-4">
                <div class="flex-1 w-full">
                    <label class="label-txt text-slate-500">è¼¸å…¥ä»£è™Ÿé–‹å•Ÿ 10 å¹´å›æ¸¬åˆ†æ</label>
                    <input type="text" id="new-stock-id" placeholder="ä¾‹å¦‚: 0056" class="bg-transparent text-white text-2xl font-black outline-none border-b-2 border-slate-700 focus:border-blue-500 w-full">
                </div>
                <button onclick="addStockCard()" class="w-full md:w-auto bg-blue-600 text-white px-8 py-4 rounded-2xl font-black hover:bg-blue-500 transition-all shadow-lg">
                    åˆ†æä¸¦åŠ å…¥ç›£æ§
                </button>
            </div>

            <div id="stock-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                </div>
        </div>

        <div id="calc-tab" class="tab-content space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="card border-b-4 border-blue-500">
                    <label class="label-txt">åŸºæº–è‚¡åƒ¹ (ä¾†æºæ–¼å›æ¸¬)</label>
                    <input type="number" id="principal-price" value="0" class="input-box text-blue-600" readonly>
                </div>
                <div class="card"><label class="label-txt">åˆå§‹æŠ•å…¥ (è¬)</label><input type="number" id="principal" value="100" class="input-box"></div>
                <div class="card"><label class="label-txt">æ­·å²å¹³å‡æ®–åˆ©ç‡ %</label><input type="number" id="yieldRate" value="0" step="0.01" class="input-box"></div>
                <div class="card"><label class="label-txt">æ­·å²å¹´åŒ–å¢å€¼ %</label><input type="number" id="priceGrowth" value="0" step="0.01" class="input-box"></div>
            </div>

            <div class="card p-6 bg-slate-50 border-2 border-dashed border-slate-300">
                <div class="flex justify-between items-center mb-4 text-sm font-bold text-slate-500"><span>è§€å¯Ÿå¹´æ•¸</span><span class="text-blue-600 font-black"><span id="yearVal">10</span> å¹´</span></div>
                <input type="range" id="years" min="1" max="30" value="10" oninput="document.getElementById('yearVal').innerText=this.value" class="w-full h-2 bg-slate-200 rounded-lg cursor-pointer">
            </div>

            <button onclick="calculate()" class="w-full bg-slate-900 text-white font-black py-5 rounded-3xl shadow-xl hover:scale-[1.01] transition-all">å¥—ç”¨æ­·å²æ•¸æ“šåŸ·è¡Œæ¨¡æ“¬</button>

            <div id="resultArea" class="hidden space-y-4">
                <div id="sumArea" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
                <div class="card p-0 overflow-hidden"><table class="w-full text-xs text-left"><thead class="bg-slate-800 text-slate-300"><tr><th class="p-4">å¹´ä»½</th><th class="p-4">è³‡ç”¢å¸‚å€¼</th><th class="p-4 text-emerald-400">ç•¶å¹´åº¦è‚¡æ¯</th></tr></thead><tbody id="detailBody" class="divide-y divide-slate-100"></tbody></table></div>
            </div>
        </div>
    </div>

    <script>
        let stockDataMap = {};

        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');
            document.getElementById('btn-' + tab).classList.add('active');
        }

        async function addStockCard() {
            const id = document.getElementById('new-stock-id').value.trim();
            if (!id) return;

            // 1. å–å¾—æ­·å²æ•¸æ“š (éå»10å¹´)
            const today = new Date();
            const tenYearsAgo = new Date(today.getFullYear() - 10, today.getMonth(), today.getDate()).toISOString().split('T')[0];
            const nowStr = today.toISOString().split('T')[0];
            
            try {
                // æŠ“å–è‚¡åƒ¹æ­·å²
                const res = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${id}&start_date=${tenYearsAgo}`);
                const priceResult = await res.json();
                
                // æŠ“å–é…æ¯æ­·å² (è¨ˆç®—å¹³å‡æ®–åˆ©ç‡)
                const divRes = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockDividend&data_id=${id}&start_date=${tenYearsAgo}`);
                const divResult = await divRes.json();

                if (priceResult.data.length > 0) {
                    const firstPrice = priceResult.data[0].close;
                    const lastPrice = priceResult.data[priceResult.data.length - 1].close;
                    
                    // è¨ˆç®— 10 å¹´å¹´åŒ–è³‡æœ¬å¢å€¼ç‡ (CAGR)
                    const years = 10;
                    const cagr = (Math.pow(lastPrice / firstPrice, 1 / years) - 1) * 100;
                    
                    // è¨ˆç®— 10 å¹´å¹³å‡æ®–åˆ©ç‡
                    const avgDiv = divResult.data.length > 0 ? 
                        (divResult.data.reduce((sum, d) => sum + d.CashDividend, 0) / years) : 0;
                    const avgYield = (avgDiv / lastPrice) * 100;

                    stockDataMap[id] = {
                        currentPrice: lastPrice,
                        cagr: cagr.toFixed(2),
                        yield: avgYield.toFixed(2),
                        offset: 0
                    };
                    renderCards();
                }
            } catch (e) { alert("æ•¸æ“šæŠ“å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä»£è™Ÿ"); }
        }

        function renderCards() {
            const container = document.getElementById('stock-container');
            container.innerHTML = "";
            Object.keys(stockDataMap).forEach(id => {
                const s = stockDataMap[id];
                container.innerHTML += `
                    <div class="card border-2 border-slate-100 hover:border-blue-500 shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-3xl font-black">${id}</span>
                            <span class="text-xs bg-slate-100 px-3 py-1 rounded-full font-bold text-slate-500">10Y BACKTEST</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-blue-50 p-3 rounded-2xl text-center">
                                <label class="label-txt text-blue-600">10Y å¹´åŒ–å¢å€¼</label>
                                <span class="text-xl font-black text-blue-800">${s.cagr}%</span>
                            </div>
                            <div class="bg-emerald-50 p-3 rounded-2xl text-center">
                                <label class="label-txt text-emerald-600">10Y å¹³å‡æ®–åˆ©ç‡</label>
                                <span class="text-xl font-black text-emerald-800">${s.yield}%</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between bg-slate-900 text-white p-4 rounded-2xl mb-4">
                            <button onclick="adjustPrice('${id}', -1)" class="text-xl font-bold px-3">-</button>
                            <div class="text-center">
                                <label class="label-txt text-slate-500">èª¿æ•´å¾Œé€²å ´åƒ¹</label>
                                <span class="text-2xl font-black">$${(parseFloat(s.currentPrice) + s.offset).toFixed(1)}</span>
                            </div>
                            <button onclick="adjustPrice('${id}', 1)" class="text-xl font-bold px-3">+</button>
                        </div>
                        <button onclick="applyAndGo('${id}')" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl hover:bg-blue-700 transition-all">
                            ä»£å…¥æ­·å²æ•¸æ“šæ¨¡æ“¬
                        </button>
                    </div>
                `;
            });
        }

        function adjustPrice(id, val) {
            stockDataMap[id].offset += val;
            renderCards();
        }

        function applyAndGo(id) {
            const s = stockDataMap[id];
            document.getElementById('principal-price').value = (parseFloat(s.currentPrice) + s.offset).toFixed(1);
            document.getElementById('yieldRate').value = s.yield;
            document.getElementById('priceGrowth').value = s.cagr;
            showTab('calc');
        }

        function calculate() {
            const principal = parseFloat(document.getElementById('principal').value) || 0;
            const yieldRate = parseFloat(document.getElementById('yieldRate').value) / 100;
            const growthRate = parseFloat(document.getElementById('priceGrowth').value) / 100;
            const years = parseInt(document.getElementById('years').value);

            let currentMV = principal;
            let html = "";
            for (let i = 1; i <= years; i++) {
                let dividend = currentMV * yieldRate;
                currentMV = currentMV * (1 + growthRate) + dividend;
                html += `<tr>
                    <td class="p-4 font-bold text-slate-400">${i}Y</td>
                    <td class="p-4 font-black text-slate-800">${currentMV.toFixed(1)} è¬</td>
                    <td class="p-4 text-emerald-600 font-bold">${dividend.toFixed(2)} è¬</td>
                </tr>`;
            }
            document.getElementById('detailBody').innerHTML = html;
            document.getElementById('resultArea').classList.remove('hidden');
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }
    </script>
</body>
</html>
